<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾è®¡éªŒæ”¶å¯¹æ¯”å·¥å…· (Design vs Dev)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* åŸºç¡€æ ·å¼ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* ç§»é™¤æ•°å­—è¾“å…¥æ¡†é»˜è®¤çš„ä¸Šä¸‹ç®­å¤´ */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }

        .checkered-bg {
            background-image: 
                linear-gradient(45deg, #2a2a2a 25%, transparent 25%), 
                linear-gradient(-45deg, #2a2a2a 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #2a2a2a 75%), 
                linear-gradient(-45deg, transparent 75%, #2a2a2a 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #1a1a1a;
        }

        /* å¸ƒå±€è°ƒæ•´ */
        #main-content-wrapper {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }

        #workspace-container {
            cursor: none; 
            overflow: auto;
            position: relative;
            flex-grow: 1;
            background-color: #0f172a;
            outline: none;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 40px; 
            padding-bottom: 100px;
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        #issues-sidebar {
            width: 300px;
            background-color: #1e293b;
            border-left: 1px solid #334155;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            flex-shrink: 0;
        }

        #layers-wrapper {
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            display: none; 
            flex-shrink: 0; 
        }

        .layer { 
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%; 
            user-select: none; pointer-events: none; 
        }
        
        img.layer {
            height: auto;
            display: block;
            transform-origin: 0 0;
        }

        #interaction-canvas { z-index: 50; pointer-events: auto; }

        /* è‡ªå®šä¹‰åŠé€æ˜åå­—å…‰æ ‡ */
        .cursor-line {
            position: fixed;
            background-color: #ef4444; 
            pointer-events: none;
            z-index: 9999;
            display: none;
            box-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
        }
        .cursor-x { width: 100vw; height: 1px; left: 0; }
        .cursor-y { height: 100vh; width: 1px; top: 0; }

        /* æ ‡è®°ç‚¹ DOM æ ·å¼ */
        .marker-point {
            position: absolute; width: 18px; height: 18px;
            border-radius: 50%;
            background-color: #ef4444; color: white; font-size: 10px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            transform: translate(-50%, -50%); z-index: 60; cursor: pointer; pointer-events: auto;
            transition: transform 0.2s, background-color 0.2s;
        }
        .marker-point:hover, .marker-point.active { transform: translate(-50%, -50%) scale(1.2); background-color: #f59e0b; z-index: 70; }
        
        .marker-line {
            position: absolute; height: 1px; background-color: #ef4444;
            transform-origin: 0 50%; z-index: 55; pointer-events: none; opacity: 0.8;
        }

        /* Tooltip */
        #marker-tooltip {
            position: absolute; background: rgba(0, 0, 0, 0.8); color: white;
            padding: 4px 8px; border-radius: 4px; font-size: 12px;
            pointer-events: none; z-index: 100; white-space: nowrap; display: none;
            backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2);
        }

        .slider-handle {
            position: absolute; top: 0; bottom: 0; width: 2px;
            background: #3b82f6; z-index: 40; pointer-events: none;
            display: none; box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
        }
        .slider-handle::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 24px; height: 24px;
            background: #3b82f6 url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='15 18 9 12 15 6'%3E%3C/polyline%3E%3Cpolyline points='9 18 3 12 9 6'%3E%3C/polyline%3E%3C/svg%3E") no-repeat center;
            border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* é—®ç­”åŠ©æ‰‹æ ·å¼ */
        #qa-fab {
            position: fixed; bottom: 24px; left: 24px;
            width: 48px; height: 48px;
            background: #3b82f6; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
            z-index: 100; cursor: pointer; transition: transform 0.2s, background-color 0.2s;
        }
        #qa-fab:hover { transform: scale(1.1); background: #2563eb; }
        
        #qa-modal {
            position: fixed; bottom: 84px; left: 24px;
            width: 380px; height: 500px;
            background: #1e293b; border: 1px solid #334155;
            border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            z-index: 100; display: none; flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

        /* AI Markdown */
        .prose h3 { font-size: 1.1em; font-weight: bold; margin-top: 1em; color: #60a5fa; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin: 0.5em 0; }
        .prose li { margin-bottom: 0.25em; }
        .prose code { background: #334155; padding: 2px 4px; border-radius: 4px; font-family: monospace; color: #f472b6; }

        /* --- æ‰“å°æ ·å¼ --- */
        @media print {
            body * { visibility: hidden; }
            #print-report-container, #print-report-container * { visibility: visible; }
            #print-report-container {
                position: absolute; left: 0; top: 0; width: 100%; height: auto;
                background: white; color: black; overflow: visible;
                z-index: 9999; display: block !important;
            }
            .no-print { display: none !important; }
            .bg-slate-900, .bg-slate-950 { background-color: white !important; color: black !important; }
            .text-slate-300, .text-slate-400, .text-slate-500 { color: #4b5563 !important; } 
            .border-slate-700 { border-color: #e5e7eb !important; }
        }
        
        /* Modal Animation */
        @keyframes modal-pop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: modal-pop 0.2s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-950 text-white h-screen flex flex-col overflow-hidden font-sans selection:bg-blue-500/30">

    <header class="h-16 bg-slate-900/80 backdrop-blur-md border-b border-slate-800 flex items-center justify-between px-6 shadow-lg z-50 shrink-0 no-print">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-600/20">
                <i data-lucide="scan-eye" class="text-white w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold tracking-tight text-white">è®¾è®¡éªŒæ”¶å¯¹æ¯”å·¥å…·</h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-wider font-semibold">Pixel Perfect QA</p>
            </div>
        </div>
        
        <div id="status-bar" class="text-xs font-medium text-slate-400 hidden md:block px-4 py-1.5 rounded-full border border-slate-700/50 bg-slate-800/50 min-h-[32px] flex items-center">
            è¯·ä¸Šä¼ å›¾ç‰‡å¼€å§‹å¯¹æ¯”
        </div>

        <div class="flex gap-3">
            <button id="btn-reupload" onclick="triggerReupload()" class="hidden px-3 py-1.5 rounded-lg hover:bg-blue-500/10 text-blue-400 border border-transparent hover:border-blue-500/20 transition flex items-center gap-2 text-xs font-medium">
                <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i> æ›´æ–°å¼€å‘å›¾
            </button>
            <input type="file" id="input-reupload" accept="image/*" class="hidden" onchange="handleReupload(event)">

            <div class="w-px bg-slate-700 h-4 my-auto"></div>

            <button onclick="resetAll()" class="px-3 py-1.5 rounded-lg hover:bg-red-500/10 text-red-400 border border-transparent hover:border-red-500/20 transition flex items-center gap-2 text-xs font-medium">
                <i data-lucide="rotate-ccw" class="w-3.5 h-3.5"></i> é‡ç½®æ‰€æœ‰
            </button>
        </div>
    </header>

    <div id="main-content-wrapper" class="no-print">
        
        <div id="upload-section" class="absolute inset-0 z-20 flex flex-col md:flex-row gap-8 p-10 items-center justify-center bg-slate-950">
            <div class="absolute inset-0 overflow-hidden pointer-events-none -z-10">
                <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-blue-600/10 rounded-full blur-3xl"></div>
                <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-600/10 rounded-full blur-3xl"></div>
            </div>

            <div tabindex="0" onpaste="handlePaste(event, 'design')" id="box-design" class="upload-box w-full max-w-md aspect-video bg-slate-900/50 border-2 border-dashed border-slate-700 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-blue-500 hover:bg-slate-800/80 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/20 focus:bg-slate-800 outline-none transition-all duration-300 group relative backdrop-blur-sm" onclick="focusBox('design')">
                <input type="file" id="input-design" accept="image/*" class="hidden" onchange="handleImageUpload(event, 'design')">
                <div class="text-center group-hover:scale-105 transition transform duration-300">
                    <div class="w-16 h-16 bg-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:bg-blue-600/20 transition-colors pointer-events-none">
                        <i data-lucide="image" class="w-8 h-8 text-slate-400 group-hover:text-blue-400"></i>
                    </div>
                    <h3 class="text-lg font-bold text-slate-200">è®¾è®¡åŸç¨¿</h3>
                    <p class="text-xs text-slate-500 mt-1 uppercase tracking-wide">ç‚¹å‡»æ­¤å¤„å¯ Ctrl+V ç²˜è´´</p>
                    <div class="mt-4">
                        <button onclick="document.getElementById('input-design').click()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded-lg shadow transition">é€‰æ‹©æ–‡ä»¶</button>
                    </div>
                </div>
                <div id="preview-text-design" class="absolute bottom-4 left-0 right-0 text-center text-emerald-400 text-xs font-mono hidden flex items-center justify-center gap-1">
                    <i data-lucide="check-circle" class="w-3 h-3"></i> <span class="filename truncate max-w-[200px]"></span>
                </div>
            </div>

            <div class="text-slate-600 font-black text-2xl italic opacity-50">VS</div>

            <div tabindex="0" onpaste="handlePaste(event, 'dev')" id="box-dev" class="upload-box w-full max-w-md aspect-video bg-slate-900/50 border-2 border-dashed border-slate-700 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-indigo-500 hover:bg-slate-800/80 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20 focus:bg-slate-800 outline-none transition-all duration-300 group relative backdrop-blur-sm" onclick="focusBox('dev')">
                <input type="file" id="input-dev" accept="image/*" class="hidden" onchange="handleImageUpload(event, 'dev')">
                <div class="text-center group-hover:scale-105 transition transform duration-300">
                    <div class="w-16 h-16 bg-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:bg-indigo-600/20 transition-colors pointer-events-none">
                        <i data-lucide="code-2" class="w-8 h-8 text-slate-400 group-hover:text-indigo-400"></i>
                    </div>
                    <h3 class="text-lg font-bold text-slate-200">å¼€å‘å®ç°</h3>
                    <p class="text-xs text-slate-500 mt-1 uppercase tracking-wide">ç‚¹å‡»æ­¤å¤„å¯ Ctrl+V ç²˜è´´</p>
                    <div class="mt-4">
                        <button onclick="document.getElementById('input-dev').click()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded-lg shadow transition">é€‰æ‹©æ–‡ä»¶</button>
                    </div>
                </div>
                <div id="preview-text-dev" class="absolute bottom-4 left-0 right-0 text-center text-emerald-400 text-xs font-mono hidden flex items-center justify-center gap-1">
                    <i data-lucide="check-circle" class="w-3 h-3"></i> <span class="filename truncate max-w-[200px]"></span>
                </div>
            </div>
        </div>

        <div id="workspace-container" class="checkered-bg hidden" tabindex="0">
            <div id="cursor-x" class="cursor-line cursor-x"></div>
            <div id="cursor-y" class="cursor-line cursor-y"></div>

            <div id="layers-wrapper">
                <canvas id="design-layer" class="layer z-10"></canvas>
                
                <div id="dev-wrapper" class="layer z-20 overflow-hidden w-full h-full transition-none">
                    <canvas id="dev-layer" class="layer transform transition-none"></canvas>
                </div>
                
                <canvas id="diff-canvas" class="layer z-30 opacity-0 pointer-events-none w-full h-full"></canvas>
                <div id="marker-overlay" class="layer z-40 pointer-events-none w-full h-full"></div>
                <canvas id="interaction-canvas" class="layer z-50 pointer-events-auto w-full h-full"></canvas>
                <div id="slider-handle" class="slider-handle"></div>
            </div>
            <div id="marker-tooltip"></div>
        </div>

        <aside id="issues-sidebar" class="hidden flex-col">
            <div class="p-4 border-b border-slate-700 bg-slate-900 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-slate-200 flex items-center gap-2">
                    <i data-lucide="list-checks" class="w-4 h-4 text-blue-400"></i> éªŒæ”¶è®°å½•
                </h3>
            </div>
            <div id="score-panel" class="p-6 bg-slate-800 border-b border-slate-700 flex flex-col items-center justify-center shrink-0 transition-colors duration-300">
                <div class="text-[10px] text-slate-400 uppercase tracking-widest mb-1 font-bold">å½“å‰å¾—åˆ†</div>
                <div id="current-score" class="text-5xl font-black text-emerald-400 tracking-tighter tabular-nums">100</div>
                <div class="text-[10px] text-slate-500 mt-2 bg-slate-900/50 px-2 py-1 rounded border border-slate-700">
                    è§„åˆ™: åŸºå‡†100åˆ† - 2åˆ†/é—®é¢˜
                </div>
            </div>
            <div id="issues-list" class="flex-grow overflow-y-auto p-2 space-y-2">
                <div class="text-center text-slate-500 text-xs py-10 italic">åœ¨â€œæµ‹é‡æ¨¡å¼â€ä¸‹ç‚¹å‡»ä¸¤ç‚¹<br>ä»¥è®°å½•é—®é¢˜å¹¶æ‰£åˆ†</div>
            </div>
            <div class="p-4 border-t border-slate-700 bg-slate-900 shrink-0 space-y-2">
                <button onclick="showPrintPreview()" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold rounded transition flex items-center justify-center gap-2 shadow-lg">
                    <i data-lucide="file-down" class="w-3.5 h-3.5"></i> ç”Ÿæˆå›¾æ–‡æŠ¥å‘Š
                </button>
            </div>
        </aside>
    </div>

    <div id="toolbar" class="bg-slate-800/90 backdrop-blur-md border-t border-slate-700 p-2 flex justify-center gap-4 hidden shrink-0 z-40 shadow-xl relative items-center no-print">
        <div class="bg-slate-900/80 p-1 rounded-lg flex border border-slate-700/50">
            <button onclick="setMode('slider')" id="btn-slider" class="mode-btn px-4 py-2 rounded-md flex items-center gap-2 text-xs font-bold transition bg-blue-600 text-white shadow-lg shadow-blue-600/20">
                <i data-lucide="columns" class="w-4 h-4"></i> æ»‘å—
            </button>
            <button onclick="setMode('measure')" id="btn-measure" class="mode-btn px-4 py-2 rounded-md flex items-center gap-2 text-xs font-bold transition text-slate-400 hover:text-white hover:bg-slate-800" title="æµ‹é‡æ—¶æŒ‰ä½ Shift å¯ç»˜åˆ¶æ°´å¹³/å‚ç›´çº¿">
                <i data-lucide="ruler" class="w-4 h-4"></i> æµ‹é‡
            </button>
            <button onclick="setMode('diff')" id="btn-diff" class="mode-btn px-4 py-2 rounded-md flex items-center gap-2 text-xs font-bold transition text-slate-400 hover:text-white hover:bg-slate-800">
                <i data-lucide="alert-triangle" class="w-4 h-4"></i> å·®å¼‚
            </button>
        </div>
        <div class="w-px bg-slate-700 mx-2 h-6"></div>
        
        <div class="flex items-center gap-1 bg-slate-900/50 p-1 rounded-lg border border-slate-700/50" title="é”®ç›˜æ–¹å‘é”®å¯ç§»åŠ¨ï¼ŒShiftåŠ é€Ÿ(10px)">
            <button onclick="onUIArrowClick(event, 0, -1)" class="p-1.5 rounded hover:bg-slate-700 text-slate-400 hover:text-white transition" title="ä¸Šç§» (Up) - Shift+ç‚¹å‡»ç§»10px"><i data-lucide="arrow-up" class="w-3.5 h-3.5"></i></button>
            <button onclick="onUIArrowClick(event, 0, 1)" class="p-1.5 rounded hover:bg-slate-700 text-slate-400 hover:text-white transition" title="ä¸‹ç§» (Down) - Shift+ç‚¹å‡»ç§»10px"><i data-lucide="arrow-down" class="w-3.5 h-3.5"></i></button>
            <button onclick="onUIArrowClick(event, -1, 0)" class="p-1.5 rounded hover:bg-slate-700 text-slate-400 hover:text-white transition" title="å·¦ç§» (Left) - Shift+ç‚¹å‡»ç§»10px"><i data-lucide="arrow-left" class="w-3.5 h-3.5"></i></button>
            <button onclick="onUIArrowClick(event, 1, 0)" class="p-1.5 rounded hover:bg-slate-700 text-slate-400 hover:text-white transition" title="å³ç§» (Right) - Shift+ç‚¹å‡»ç§»10px"><i data-lucide="arrow-right" class="w-3.5 h-3.5"></i></button>
            
            <div class="w-px bg-slate-700 h-4 mx-1"></div>
            
            <button onclick="resetDevOffset()" class="p-1.5 rounded hover:bg-slate-700 text-slate-400 hover:text-red-400 transition" title="é‡ç½®ä½ç½® (0,0)">
                <i data-lucide="crosshair" class="w-3.5 h-3.5"></i>
            </button>

            <div class="flex items-center gap-1 ml-1">
                <span class="text-[10px] text-slate-500 font-mono">X</span>
                <input type="number" id="input-offset-x" value="0" oninput="handleManualOffsetInput()" class="w-14 bg-slate-950 border border-slate-700 rounded px-1 py-0.5 text-xs text-center text-emerald-400 focus:border-blue-500 focus:text-white outline-none font-mono transition-colors">
            </div>
            <div class="flex items-center gap-1">
                <span class="text-[10px] text-slate-500 font-mono">Y</span>
                <input type="number" id="input-offset-y" value="0" oninput="handleManualOffsetInput()" class="w-14 bg-slate-950 border border-slate-700 rounded px-1 py-0.5 text-xs text-center text-emerald-400 focus:border-blue-500 focus:text-white outline-none font-mono transition-colors">
            </div>
        </div>
        
        <div class="w-px bg-slate-700 mx-2 h-6"></div>
        <button onclick="toggleAIModal()" class="px-4 py-2 rounded-lg flex items-center gap-2 text-xs font-bold transition bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-500 hover:to-indigo-500 text-white shadow-lg shadow-indigo-500/30 border border-white/10">
            <i data-lucide="sparkles" class="w-4 h-4"></i> AI éªŒæ”¶
        </button>
        <div class="w-px bg-slate-700 mx-2 h-6"></div>
        <div class="flex items-center gap-3 px-2">
            <i data-lucide="layers" class="w-4 h-4 text-slate-400"></i>
            <input type="range" id="opacity-slider" min="0" max="100" value="100" class="w-24 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500 hover:accent-blue-400 transition-all" oninput="updateOpacity(this.value)">
        </div>
    </div>

    <div id="info-panel" class="fixed bottom-20 right-[320px] bg-slate-900/90 backdrop-blur border border-slate-700 p-3 rounded-lg shadow-xl hidden z-50 pointer-events-none no-print">
        <div class="text-xs font-mono text-slate-300">
            <span id="live-dist" class="text-emerald-400 font-bold text-sm">0px</span>
            <span class="mx-1 text-slate-600">|</span> 
            dx:<span id="live-dx">0</span> dy:<span id="live-dy">0</span>
        </div>
    </div>

    <div id="warning-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4 no-print">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-sm flex flex-col rounded-xl shadow-2xl transform animate-pop">
            <div class="p-6 text-center">
                <div class="w-12 h-12 bg-amber-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="alert-triangle" class="w-6 h-6 text-amber-500"></i>
                </div>
                <h3 class="text-lg font-bold text-white mb-2">å°ºå¯¸æç¤º</h3>
                <p class="text-slate-400 text-sm mb-6">è¯·ä¸Šä¼ å®½åº¦ <strong>â‰¥ 750px</strong> çš„ç•Œé¢å°ºå¯¸ï¼Œä»¥ç¡®ä¿éªŒæ”¶ç²¾åº¦ã€‚</p>
                <button onclick="closeWarningModal()" class="w-full py-2.5 bg-slate-800 hover:bg-slate-700 text-white text-sm font-bold rounded-lg transition border border-slate-700">
                    æˆ‘çŸ¥é“äº†
                </button>
            </div>
        </div>
    </div>
    
    <button id="qa-fab" onclick="toggleQAModal()" class="no-print text-white shadow-xl transition-transform hover:scale-110">
        <i data-lucide="message-circle-question" class="w-6 h-6"></i>
    </button>

    <div id="qa-modal" class="no-print flex flex-col">
        <div class="p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
            <h3 class="font-bold text-white flex items-center gap-2">
                <i data-lucide="bot" class="w-5 h-5 text-blue-400"></i> å¸¸è§é—®é¢˜åŠ©æ‰‹
            </h3>
            <button onclick="toggleQAModal()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
        </div>
        <div id="qa-messages" class="flex-grow overflow-y-auto p-4 space-y-3 text-sm">
            </div>
        <div class="p-3 border-t border-slate-700 bg-slate-800">
            <input type="text" id="qa-input" placeholder="è¾“å…¥å…³é”®è¯æœç´¢..." class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:border-blue-500 outline-none transition" oninput="filterQuestions(this.value)">
        </div>
    </div>

    <div id="print-report-container" class="fixed inset-0 z-[100] bg-white text-black overflow-y-auto hidden">
        <div class="sticky top-0 bg-white border-b border-gray-200 p-4 flex justify-between items-center no-print shadow-sm z-50">
            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i data-lucide="file-text" class="text-emerald-600"></i> éªŒæ”¶æŠ¥å‘Šé¢„è§ˆ
            </h2>
            <div class="flex gap-3">
                <button id="btn-download-snapshot" onclick="downloadReportSnapshot()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow flex items-center gap-2 text-sm font-bold transition">
                    <i data-lucide="camera" class="w-4 h-4"></i> ä¸‹è½½é•¿å›¾å¿«ç…§
                </button>
                <button onclick="window.print()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded shadow flex items-center gap-2 text-sm font-bold transition">
                    <i data-lucide="printer" class="w-4 h-4"></i> æ‰“å° / å¦å­˜ä¸ºPDF
                </button>
                <button onclick="closePrintPreview()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded text-sm font-bold transition">
                    å…³é—­
                </button>
            </div>
        </div>
        <div class="max-w-4xl mx-auto p-8 md:p-12 bg-white min-h-screen" id="report-content"></div>
    </div>

    <div id="ai-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 no-print">
        <div class="bg-slate-800 border border-slate-600 w-full max-w-2xl max-h-[80vh] flex flex-col rounded-xl shadow-2xl">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50 rounded-t-xl">
                <div class="flex items-center gap-2 text-purple-400">
                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                    <h2 class="font-bold text-lg text-white">Gemini æ™ºèƒ½éªŒæ”¶åŠ©æ‰‹</h2>
                </div>
                <button onclick="toggleAIModal()" class="text-slate-400 hover:text-white transition"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow bg-slate-800" id="ai-content-area">
                <div class="text-center space-y-4 py-8">
                    <div class="w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="bot" class="w-8 h-8 text-purple-400"></i>
                    </div>
                    <p class="text-slate-300">æˆ‘å¯ä»¥å¸®ä½ å¯¹æ¯”è®¾è®¡å›¾ä¸å¼€å‘å›¾ï¼Œæ‰¾å‡ºè‚‰çœ¼å®¹æ˜“å¿½ç•¥çš„è§†è§‰é—®é¢˜ã€‚</p>
                    <button onclick="runAIAnalysis()" class="mt-4 px-6 py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-bold shadow-lg transition flex items-center gap-2 mx-auto">
                        <i data-lucide="zap"></i> å¼€å§‹æ™ºèƒ½åˆ†æ
                    </button>
                </div>
            </div>
            <div id="ai-loading" class="hidden p-8 flex flex-col items-center justify-center text-center">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-purple-500 mb-4"></div>
                <p class="text-purple-300 animate-pulse">Gemini æ­£åœ¨â€œçœ‹â€è¿™ä¸¤å¼ å›¾...</p>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; 

        lucide.createIcons();
        const state = {
            designImg: null,
            devImg: null,
            devOffset: { x: 0, y: 0 },
            mode: 'slider', 
            isLoaded: false,
            sliderPos: 50, 
            measure: { active: false, p1: null, p2: null },
            issues: [], 
            width: 750, // Internal Logical Width Fixed at 750
            height: 0,
            designScale: 1,
            devScale: 1
        };

        // QA Data
        const qaData = [
            { q: "è¿™ä¸ªå·¥å…·æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ", a: "æå‡ç•Œé¢ä¸Šçº¿è´¨é‡ï¼Œå‡å°‘éªŒæ”¶æŸè€—ã€‚" },
            { q: "å¦‚ä½•ä¸Šä¼ å›¾ç‰‡ï¼Ÿ", a: "æœ‰ä¸¤ç§ä¸Šä¼ æ–¹å¼ï¼š1.å°†å›¾ç‰‡å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œç‚¹å‡»ä¸Šä¼ åŒºåŸŸåCtrl+Vç²˜è´´ï¼›2.ç‚¹å‡»ä¸Šä¼ åŒºåŸŸå†…çš„æŒ‰é’®é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ã€‚" },
            { q: "æ‰“åˆ†æ ‡å‡†æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ", a: "é‡‡ç”¨ä¼ ç»Ÿçš„æ‰£åˆ†åˆ¶ï¼Œ1ä¸ªé—®é¢˜æ‰£2åˆ†ï¼Œè¶…å‡º50ä¸ªé—®é¢˜ä¼šæ‰£è‡³è´Ÿåˆ†ã€‚60åˆ†ä»¥ä¸Šå³ä¸ºåˆæ ¼" },
            { q: "ä¸‰ä¸ªæ¨¡å¼åˆ†åˆ«æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ", a: "æ»‘å—æ¨¡å¼é€šè¿‡å…‰æ ‡å·¦å³æ»‘åŠ¨ï¼Œå¿«é€Ÿæµè§ˆ2å¼ ç•Œé¢æ¯”è¾ƒå¤§çš„ä¸ä¸€è‡´é—®é¢˜ï¼›å·®å¼‚æ¨¡å¼é€šè¿‡æ»¤é•œæ•ˆæœï¼Œé‡åˆçš„åœ°æ–¹æ˜¾ç¤ºæœ¬è‰²ï¼Œä¸é‡åˆçš„åœ°æ–¹æ˜¾ç¤ºçº¢è‰²ï¼Œèƒ½åƒç´ çº§ç”„åˆ«ä¸¤å¼ ç•Œé¢ä¸ä¸€è‡´çš„åœ°æ–¹ï¼›æµ‹é‡æ¨¡å¼ä¸‹å¯ä»¥é€šè¿‡å…‰æ ‡æµ‹é‡ï¼ŒåŒä¸€å…ƒç´ åœ¨ä¸¤å¼ å›¾ä¸­çš„åƒç´ åç§»ï¼Œå¹¶æœ€åç”Ÿæˆå›¾æ–‡æŠ¥å‘Šã€‚" },
            { q: "å¼€å‘ä¿®æ”¹åï¼Œæƒ³ä¼ å›¾é‡æ–°éªŒè¯ï¼Œå¦‚ä½•å¿«é€Ÿæ“ä½œï¼Ÿ", a: "ç‚¹å‡»å³ä¸Šè§’çš„æ›´æ–°å¼€å‘å›¾ï¼Œé‡æ–°ä¸Šä¼ å¼€å‘å›¾ã€‚ï¼ˆå±Šæ—¶ï¼Œè®¾è®¡å›¾å¹¶ä¸ä¼šå˜åŒ–ï¼‰" },
            { q: "å¦‚ä½•ä¸€é”®æ¸…ç©ºæ‰€æœ‰è§†å›¾ï¼Ÿ", a: "ç‚¹å‡»å³ä¸Šè§’é‡ç½®æ‰€æœ‰æŒ‰é’®ã€‚" },
            { q: "ä¸Šä¼ å¤šå¤§å›¾ç‰‡ï¼Ÿ", a: "å®½åº¦ä¸å°äº750pxéƒ½å¯ä»¥ï¼Œå¦‚æœå°äº750 ä¼šè¿›è¡ŒæŠ¥é”™æé†’ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨å°†å¼€å‘å›¾å®½åº¦å¯¹é½åˆ°è®¾è®¡å›¾å®½åº¦ã€‚" },
            { q: "éªŒæ”¶æŠ¥å‘Šä¸­çš„åƒç´ æ˜¯ä»¥å¤šå°‘ä¸ºåŸºå‡†ï¼Ÿ", a: "ç•Œé¢ä»¥å®½åº¦750pxä½œä¸ºåŸºå‡†å€¼è¿›è¡Œæµ‹é‡ï¼ŒæŠ¥å‘Šä¸­è¾“å‡ºçš„æ•°å€¼å‡ä¸º750pxåŸºå‡†ä¸‹çš„åƒç´ å€¼ã€‚" },
            { q: "ä¸ºä»€ä¹ˆç‚¹AIéªŒæ”¶æ²¡æœ‰ååº”ï¼Ÿ", a: "å¥½é—®é¢˜ã€‚å› ä¸ºä½ æ˜¯åœ¨æœ¬åœ°è¿è¡Œå‘€ï¼ŒAIéªŒæ”¶éœ€è¦è°ƒç”¨å…¶ä»–Agentã€‚ä¸”æ­¤åŠŸèƒ½è¿˜ä¸å®Œå–„ï¼Œæš‚æ—¶è¿˜æ²¡æœ‰å¯ä»¥ä½¿ç”¨ã€‚" },
            { q: "æˆ‘æƒ³è®©å±€éƒ¨åŒºåŸŸä¸è®¾è®¡ç¨¿åˆä¸Šï¼Œæ€ä¹ˆå¯ä»¥æ‹–åŠ¨å¼€å‘å›¾å—ï¼Ÿ", a: "ç‚¹å‡»ã€ç•Œé¢ä¸‹æ–¹ã€‘çš„ä¸Šä¸‹å·¦å³é”®å³å¯ã€‚æˆ–è€…ç›´æ¥åœ¨X/Yè¾“å…¥æ¡†è¾“å…¥æ•°å€¼ã€‚ç‚¹æ—è¾¹é¶å¿ƒiconå½’é›¶ã€‚" },
            { q: "ç‚¹ã€ç•Œé¢ä¸Šçš„ä¸Šä¸‹å·¦å³é”®ã€‘æ˜¯ä¸€ä¸ªåƒç´ ä¸€ä¸ªåƒç´ ç§»åŠ¨ï¼Œå¥½æ…¢ï¼Œæœ‰å¿«æ·æ“ä½œå—ï¼Ÿ", a: "ç”¨ã€é”®ç›˜çš„ä¸Šä¸‹å·¦å³é”®ã€‘æ“ä½œï¼Œä¸ºä»¥1pxä¸ºå•ä½çš„åƒç´ ç§»åŠ¨ã€‚æŒ‰ä½é”®ç›˜ä¸Šçš„shifté”®ï¼Œå†æŒ‰ã€é”®ç›˜çš„ä¸Šä¸‹å·¦å³é”®ã€‘å³ä¸ºä»¥10pxä¸ºå•ä½çš„åƒç´ ç§»åŠ¨ã€‚" },
            { q: "ç”ŸæˆéªŒæ”¶æŠ¥å‘Šåæ€ä¹ˆå¯¼å‡ºï¼Ÿ", a: "å¯ä»¥ç‚¹ã€ä¸‹è½½é•¿å›¾å¿«ç…§ã€‘è¿›è¡Œä¸€é”®å¯¼å‡ºå›¾ç‰‡ï¼Œæˆ–è€…ç‚¹å‡»ã€æ‰“å°/å¦å­˜ä¸ºPDFã€‘ç”ŸæˆPDFæ–‡ä»¶ã€‚" }
        ];

        const els = {
            uploadSection: document.getElementById('upload-section'),
            workspace: document.getElementById('workspace-container'),
            toolbar: document.getElementById('toolbar'),
            layersWrapper: document.getElementById('layers-wrapper'),
            devWrapper: document.getElementById('dev-wrapper'),
            diffCanvas: document.getElementById('diff-canvas'),
            interactionCanvas: document.getElementById('interaction-canvas'),
            markerOverlay: document.getElementById('marker-overlay'),
            markerTooltip: document.getElementById('marker-tooltip'),
            sliderHandle: document.getElementById('slider-handle'),
            infoPanel: document.getElementById('info-panel'),
            statusBar: document.getElementById('status-bar'),
            aiModal: document.getElementById('ai-modal'),
            aiContent: document.getElementById('ai-content-area'),
            aiLoading: document.getElementById('ai-loading'),
            opacitySlider: document.getElementById('opacity-slider'),
            // ä¿®æ”¹äº†è¿™é‡Œï¼Œä½¿ç”¨äº† Input å…ƒç´ 
            inputOffsetX: document.getElementById('input-offset-x'),
            inputOffsetY: document.getElementById('input-offset-y'),
            
            btnReupload: document.getElementById('btn-reupload'),
            inputReupload: document.getElementById('input-reupload'),
            issuesSidebar: document.getElementById('issues-sidebar'),
            issuesList: document.getElementById('issues-list'),
            printContainer: document.getElementById('print-report-container'),
            reportContent: document.getElementById('report-content'),
            warningModal: document.getElementById('warning-modal'),
            currentScore: document.getElementById('current-score'),
            scorePanel: document.getElementById('score-panel'),
            cursorX: document.getElementById('cursor-x'),
            cursorY: document.getElementById('cursor-y'),
            boxDesign: document.getElementById('box-design'),
            boxDev: document.getElementById('box-dev'),
            // New canvas references for drawing layers
            designLayer: document.getElementById('design-layer'),
            devLayer: document.getElementById('dev-layer'),
            qaModal: document.getElementById('qa-modal'),
            qaMessages: document.getElementById('qa-messages'),
            qaInput: document.getElementById('qa-input')
        };

        let ctxInteract = els.interactionCanvas.getContext('2d');
        let ctxDiff = els.diffCanvas.getContext('2d');
        let ctxDesign = els.designLayer.getContext('2d');
        let ctxDev = els.devLayer.getContext('2d');
        
        // --- QA Logic ---
        function toggleQAModal() {
            if (els.qaModal.style.display === 'flex') {
                els.qaModal.style.display = 'none';
            } else {
                els.qaModal.style.display = 'flex';
                if (els.qaMessages.children.length === 0) renderQAList('');
                els.qaInput.focus();
            }
        }

        function renderQAList(filterText) {
            els.qaMessages.innerHTML = '';
            
            // Welcome message
            if (!filterText) {
                const welcome = document.createElement('div');
                welcome.className = "bg-blue-600/20 text-blue-200 p-3 rounded-lg mb-3";
                welcome.innerText = "ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯éªŒæ”¶å°åŠ©æ‰‹ã€‚æ‚¨å¯ä»¥ç›´æ¥ç‚¹å‡»ä¸‹æ–¹é—®é¢˜ï¼Œæˆ–åœ¨è¾“å…¥æ¡†æœç´¢ã€‚";
                els.qaMessages.appendChild(welcome);
            }

            const filtered = qaData.filter(item => item.q.includes(filterText));
            
            if (filtered.length === 0) {
                const noMatch = document.createElement('div');
                noMatch.className = "text-slate-500 text-center mt-4";
                noMatch.innerText = "æ²¡æœ‰æ‰¾åˆ°ç›¸å…³é—®é¢˜";
                els.qaMessages.appendChild(noMatch);
            } else {
                filtered.forEach((item, index) => {
                    const chip = document.createElement('div');
                    chip.className = "bg-slate-700 hover:bg-slate-600 text-slate-200 p-2 rounded cursor-pointer transition text-sm mb-2 border border-slate-600";
                    chip.innerText = item.q;
                    chip.onclick = () => showAnswer(item);
                    els.qaMessages.appendChild(chip);
                });
            }
        }

        function showAnswer(item) {
            els.qaMessages.innerHTML = '';
            const qBubble = document.createElement('div');
            qBubble.className = "self-end bg-blue-600 text-white p-3 rounded-lg rounded-tr-none mb-3 ml-auto max-w-[80%]";
            qBubble.innerText = item.q;
            els.qaMessages.appendChild(qBubble);

            const aBubble = document.createElement('div');
            aBubble.className = "self-start bg-slate-700 text-slate-200 p-3 rounded-lg rounded-tl-none mb-4 max-w-[90%]";
            aBubble.innerText = item.a;
            els.qaMessages.appendChild(aBubble);

            const backBtn = document.createElement('button');
            backBtn.className = "text-blue-400 text-xs hover:underline mt-2";
            backBtn.innerText = "â† è¿”å›é—®é¢˜åˆ—è¡¨";
            backBtn.onclick = () => {
                els.qaInput.value = '';
                renderQAList('');
            };
            els.qaMessages.appendChild(backBtn);
            els.qaMessages.scrollTop = els.qaMessages.scrollHeight;
        }

        function filterQuestions(val) {
            renderQAList(val);
        }

        // --- åˆ†æ•° management ---
        function updateScore() {
            const score = 100 - (state.issues.length * 2);
            els.currentScore.innerText = score;
            let colorClass = "text-emerald-400"; 
            if(score < 60) colorClass = "text-red-500";
            else if (score < 90) colorClass = "text-amber-400";
            els.currentScore.className = `text-5xl font-black ${colorClass} tracking-tighter tabular-nums transition-colors duration-300`;
        }

        function showWarningModal() { els.warningModal.classList.remove('hidden'); }
        function closeWarningModal() { els.warningModal.classList.add('hidden'); }
        function focusBox(type) { document.getElementById(`box-${type}`).focus(); }

        // --- å›¾ç‰‡å¤„ç†é€»è¾‘ ---
        function processImageFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        if (img.width < 750) { showWarningModal(); resolve(null); return; }
                        resolve(img);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // --- ç²˜è´´é€»è¾‘ ---
        function handlePaste(event, type) {
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    const blob = item.getAsFile();
                    processImageFile(blob).then(processedImg => {
                        if (!processedImg) return;
                        applyImageToState(processedImg, type, `Pasted_Image.png`);
                    });
                    event.preventDefault(); 
                    return;
                }
            }
        }

        function applyImageToState(img, type, filename) {
            if (type === 'design') state.designImg = img;
            else state.devImg = img;

            const textEl = document.getElementById(`preview-text-${type}`);
            textEl.querySelector('.filename').textContent = `${filename} (${img.width}x${Math.floor(img.height)})`;
            textEl.classList.remove('hidden');
            
            checkReady();
        }

        async function handleImageUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            const input = event.target;
            const processedImg = await processImageFile(file);
            if (!processedImg) { input.value = ''; return; }
            applyImageToState(processedImg, type, file.name);
        }

        function triggerReupload() { els.inputReupload.click(); }

        async function handleReupload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const input = event.target;
            const processedImg = await processImageFile(file);
            if (!processedImg) { input.value = ''; return; }

            state.devImg = processedImg;
            initWorkspace(true);
            input.value = '';
        }

        function checkReady() {
            if (state.designImg && state.devImg) initWorkspace();
        }

        function initWorkspace(isReupload = false) {
            state.isLoaded = true;
            els.uploadSection.classList.add('hidden');
            els.toolbar.classList.remove('hidden');
            els.workspace.classList.remove('hidden');
            els.layersWrapper.style.display = 'block';
            els.btnReupload.classList.remove('hidden');
            els.issuesSidebar.classList.remove('hidden');

            state.width = 750;
            state.designScale = 750 / state.designImg.width; 
            state.devScale = 750 / state.devImg.width; 

            state.height = state.designImg.height * state.designScale;
            
            els.layersWrapper.style.width = '750px';
            els.layersWrapper.style.height = state.height + 'px';
            
            [els.interactionCanvas, els.diffCanvas, els.designLayer, els.devLayer].forEach(c => { 
                c.width = 750; 
                c.height = state.height; 
            });

            ctxDesign.drawImage(state.designImg, 0, 0, 750, state.height);
            updateDevLayer();
            
            if (!isReupload) {
                updateScore();
                setMode('slider');
                window.addEventListener('keydown', handleKeydown);
                els.workspace.addEventListener('mousemove', handleMouseMove);
                els.workspace.addEventListener('click', handleCanvasClick);
                els.workspace.addEventListener('mouseleave', () => {
                    els.cursorX.style.display = 'none';
                    els.cursorY.style.display = 'none';
                });
                els.workspace.addEventListener('mouseenter', () => {
                    els.cursorX.style.display = 'block';
                    els.cursorY.style.display = 'block';
                });
            } else {
                setMode(state.mode);
                updateDevPosition();
            }
            
            updateStatusBarInfo();
            lucide.createIcons();
            els.workspace.focus();
        }

        function updateDevLayer() {
            ctxDev.clearRect(0, 0, 750, state.height);
            const dw = 750;
            const dh = state.devImg.height * state.devScale;
            ctxDev.drawImage(state.devImg, state.devOffset.x, state.devOffset.y, dw, dh);
        }

        function updateStatusBarInfo() {
            const dW = Math.floor(state.designImg.width); 
            const dH = Math.floor(state.designImg.height);
            const devW = Math.floor(state.devImg.width); 
            const devH = Math.floor(state.devImg.height);
            els.statusBar.innerHTML = `<div class="flex items-center gap-3"><span class="flex items-center gap-1.5 text-slate-300"><i data-lucide="image" class="w-3.5 h-3.5 text-blue-400"></i><span>è®¾è®¡: <span class="font-mono text-white">${dW}x${dH}</span></span></span><span class="text-slate-600">/</span><span class="flex items-center gap-1.5 text-slate-300"><i data-lucide="code-2" class="w-3.5 h-3.5 text-indigo-400"></i><span>å¼€å‘: <span class="font-mono text-white">${devW}x${devH}</span></span></span><span class="ml-2 text-[10px] text-emerald-400 border border-emerald-900/50 rounded px-1.5 bg-emerald-900/20">é€»è¾‘ç”»å¸ƒ: 750px</span></div>`;
            lucide.createIcons();
        }

        // --- æµ‹é‡ä¸é—®é¢˜ ---
        function addIssue(p1, p2) {
            const dx = Math.round(p2.x - p1.x);
            const dy = Math.round(p2.y - p1.y);
            const dist = Math.sqrt(dx*dx + dy*dy).toFixed(1);
            const issue = { id: Date.now(), index: state.issues.length + 1, p1: { ...p1 }, p2: { ...p2 }, dx, dy, dist };
            state.issues.push(issue);
            renderMarkers();
            renderSidebarList();
            updateScore();
        }

        function deleteIssue(id) {
            state.issues = state.issues.filter(i => i.id !== id);
            state.issues.forEach((iss, idx) => iss.index = idx + 1);
            renderMarkers();
            renderSidebarList();
            updateScore();
        }

        function renderMarkers() {
            els.markerOverlay.innerHTML = '';
            state.issues.forEach(issue => {
                const line = document.createElement('div');
                line.className = 'marker-line';
                const length = Math.sqrt(Math.pow(issue.p2.x - issue.p1.x, 2) + Math.pow(issue.p2.y - issue.p1.y, 2));
                const angle = Math.atan2(issue.p2.y - issue.p1.y, issue.p2.x - issue.p1.x) * 180 / Math.PI;
                line.style.width = `${length}px`; line.style.left = `${issue.p1.x}px`; line.style.top = `${issue.p1.y}px`;
                line.style.transform = `rotate(${angle}deg)`;
                els.markerOverlay.appendChild(line);

                const marker = document.createElement('div');
                marker.className = 'marker-point';
                marker.textContent = issue.index;
                marker.style.left = `${issue.p2.x}px`; marker.style.top = `${issue.p2.y}px`;
                marker.dataset.id = issue.id;
                marker.addEventListener('mouseenter', () => {
                    els.markerTooltip.innerHTML = `<div class="font-bold text-amber-400 mb-1">é—®é¢˜ç‚¹ #${issue.index}</div><div class="font-mono">X: ${issue.dx > 0 ? '+' : ''}${issue.dx}px<br>Y: ${issue.dy > 0 ? '+' : ''}${issue.dy}px<br>è·ç¦»: ${issue.dist}px</div>`;
                    els.markerTooltip.style.display = 'block';
                    els.markerTooltip.style.left = (issue.p2.x + 15) + 'px'; els.markerTooltip.style.top = (issue.p2.y - 10) + 'px';
                });
                marker.addEventListener('mouseleave', () => els.markerTooltip.style.display = 'none');
                els.markerOverlay.appendChild(marker);
            });
        }

        function renderSidebarList() {
            els.issuesList.innerHTML = '';
            if (state.issues.length === 0) {
                els.issuesList.innerHTML = `<div class="text-center text-slate-500 text-xs py-10 italic">åœ¨â€œæµ‹é‡æ¨¡å¼â€ä¸‹ç‚¹å‡»ä¸¤ç‚¹<br>ä»¥è®°å½•é—®é¢˜</div>`;
                return;
            }
            state.issues.forEach(issue => {
                const item = document.createElement('div');
                item.className = "group flex items-center justify-between p-3 bg-slate-800/50 border border-slate-700/50 rounded-lg hover:border-blue-500/50 hover:bg-slate-800 transition text-xs";
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-5 h-5 rounded-full bg-slate-700 text-slate-300 flex items-center justify-center font-bold border border-slate-600 group-hover:bg-blue-600 group-hover:text-white group-hover:border-blue-500 transition">${issue.index}</div>
                        <div class="font-mono text-slate-400"><span class="${issue.dx!==0?'text-red-400':''} mr-1">X:${issue.dx}</span><span class="${issue.dy!==0?'text-red-400':''}">Y:${issue.dy}</span></div>
                    </div>
                    <button class="delete-btn p-1 text-slate-500 hover:text-red-400 transition opacity-0 group-hover:opacity-100" title="åˆ é™¤"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                `;
                item.addEventListener('mouseenter', () => { const marker = document.querySelector(`.marker-point[data-id="${issue.id}"]`); if(marker) marker.classList.add('active'); });
                item.addEventListener('mouseleave', () => { const marker = document.querySelector(`.marker-point[data-id="${issue.id}"]`); if(marker) marker.classList.remove('active'); });
                item.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteIssue(issue.id); });
                els.issuesList.appendChild(item);
            });
            lucide.createIcons();
        }

        function createGlobalSnapshots() {
            const canvas = document.createElement('canvas');
            canvas.width = 750;
            
            const designH = state.height;
            const devH = (state.devImg.height * state.devScale) + state.devOffset.y; 
            const maxH = Math.max(designH, devH);
            
            canvas.height = maxH;
            const ctx = canvas.getContext('2d');

            // --- ä¿®å¤ç‚¹ï¼šå°† els.imgDesign æ›´æ”¹ä¸º state.designImg ---
            ctx.drawImage(state.designImg, 0, 0, 750, state.height);
            const designData = canvas.toDataURL('image/png');

            ctx.clearRect(0, 0, 750, maxH);
            ctx.fillStyle = "#1e293b"; ctx.fillRect(0, 0, 750, maxH);
            
            const dw = 750;
            const dh = state.devImg.height * state.devScale;
            ctx.drawImage(state.devImg, state.devOffset.x, state.devOffset.y, dw, dh);

            state.issues.forEach(issue => {
                ctx.shadowColor = "rgba(0,0,0,0.8)"; ctx.shadowBlur = 10; ctx.lineWidth = 3;
                ctx.beginPath(); ctx.moveTo(issue.p1.x, issue.p1.y); ctx.lineTo(issue.p2.x, issue.p2.y); 
                ctx.strokeStyle = "#ef4444"; ctx.stroke();

                ctx.beginPath(); ctx.arc(issue.p1.x, issue.p1.y, 8, 0, Math.PI*2); ctx.fillStyle = "#3b82f6"; ctx.fill(); ctx.strokeStyle = "white"; ctx.stroke();
                ctx.beginPath(); ctx.arc(issue.p2.x, issue.p2.y, 8, 0, Math.PI*2); ctx.fillStyle = "#ef4444"; ctx.fill(); ctx.strokeStyle = "white"; ctx.stroke();
                
                ctx.font = `bold 20px sans-serif`;
                ctx.fillStyle = "white"; ctx.strokeStyle = "red"; ctx.lineWidth = 3;
                ctx.strokeText(issue.index, issue.p2.x + 15, issue.p2.y);
                ctx.fillText(issue.index, issue.p2.x + 15, issue.p2.y);
            });

            const devData = canvas.toDataURL('image/png');
            return { design: designData, dev: devData };
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆå•ä¸ªé—®é¢˜çš„å¿«ç…§
         function createIssueSnapshot(issue) {
             // å®é™…ä¸Šä»£ç é‡Œå¹¶æ²¡æœ‰ç”¨åˆ°è¿™ä¸ªå‡½æ•°æ¥åšå¿«ç…§ï¼Œè€Œæ˜¯ç”¨å…¨å›¾å¿«ç…§ã€‚
             // å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œè¡¥å……ï¼Œä½†å½“å‰ createGlobalSnapshots å·²ç»è¶³å¤Ÿã€‚
             return null;
        }

        function downloadReportSnapshot() {
            const btn = document.getElementById('btn-download-snapshot');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> ç”Ÿæˆä¸­...`;
            btn.disabled = true;
            lucide.createIcons();

            showPrintPreview();

            setTimeout(() => {
                html2canvas(document.getElementById('report-content'), {
                    scale: 2, 
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    windowWidth: 1200 
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Design_QA_Report_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    btn.innerHTML = originalText; btn.disabled = false; lucide.createIcons();
                }).catch(err => { console.error(err); alert('å¿«ç…§ç”Ÿæˆå¤±è´¥'); btn.innerHTML = originalText; btn.disabled = false; });
            }, 500);
        }

        function showPrintPreview() {
            if (state.issues.length === 0) { alert("æ²¡æœ‰å¯å¯¼å‡ºçš„é—®é¢˜ã€‚"); return; }
            const dateStr = new Date().toLocaleString('zh-CN', { hour12: false });
            const finalScore = 100 - (state.issues.length * 2);
            let scoreColor = "text-emerald-600"; let scoreBg = "bg-emerald-50"; let scoreLabel = "ä¼˜ç§€";
            if(finalScore < 60) { scoreColor = "text-red-600"; scoreBg = "bg-red-50"; scoreLabel = "ä¸åˆæ ¼"; }
            else if(finalScore < 90) { scoreColor = "text-amber-600"; scoreBg = "bg-amber-50"; scoreLabel = "è‰¯å¥½"; }

            const snapshots = createGlobalSnapshots();

            let html = `
                <div class="mb-8 border-b border-gray-200 pb-6">
                    <div class="flex justify-between items-start">
                        <div><h1 class="text-3xl font-bold text-gray-900 mb-1">è®¾è®¡éªŒæ”¶é—®é¢˜æŠ¥å‘Š</h1><p class="text-gray-500 text-sm">Design QA Report (Base: 750px)</p></div>
                        <div class="text-right"><div class="text-sm text-gray-500">ç”Ÿæˆæ—¶é—´</div><div class="font-medium text-gray-900">${dateStr}</div></div>
                    </div>
                    <div class="mt-6 p-6 rounded-xl ${scoreBg} border border-gray-100 flex items-center justify-between">
                        <div><div class="text-sm text-gray-600 font-medium uppercase tracking-wider">æœ€ç»ˆå¾—åˆ†</div><div class="text-5xl font-black ${scoreColor} mt-1">${finalScore} <span class="text-2xl text-gray-400 font-normal">/ 100</span></div></div>
                        <div class="text-right"><div class="text-sm text-gray-600">å…±å‘ç°é—®é¢˜</div><div class="text-2xl font-bold text-gray-900">${state.issues.length} <span class="text-sm font-normal text-gray-500">å¤„</span></div><div class="mt-1 inline-block px-3 py-1 rounded-full text-xs font-bold bg-white shadow-sm border border-gray-200 ${scoreColor}">${scoreLabel}</div></div>
                    </div>
                </div>

                <div class="mb-10">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-blue-500 pl-3">å¯è§†åŒ–éªŒæ”¶è¯æ®</h2>
                    <div class="print-row flex flex-col md:flex-row gap-4">
                        <div class="print-col flex-1 border border-gray-200 rounded-lg overflow-hidden bg-gray-50">
                            <div class="bg-gray-100 p-2 text-center text-xs font-bold text-gray-500 border-b border-gray-200">è®¾è®¡æ•ˆæœå›¾</div>
                            <img src="${snapshots.design}" class="w-full h-auto block">
                        </div>
                        <div class="print-col flex-1 border border-gray-200 rounded-lg overflow-hidden bg-gray-50">
                            <div class="bg-gray-100 p-2 text-center text-xs font-bold text-gray-500 border-b border-gray-200">å¼€å‘å®ç°å›¾ (å«æ ‡è®°)</div>
                            <img src="${snapshots.dev}" class="w-full h-auto block">
                        </div>
                    </div>
                </div>
                
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-red-500 pl-3">è¯¦ç»†é—®é¢˜æ¸…å•</h2>
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-3 w-16 text-center">åºå·</th>
                                    <th class="px-6 py-3">é—®é¢˜æè¿° / åæ ‡</th>
                                    <th class="px-6 py-3">åç§»æ•°æ® (750pxåŸºå‡†)</th>
                                    <th class="px-6 py-3 text-right">æ‰£åˆ†</th>
                                </tr>
                            </thead>
                            <tbody>`;

            state.issues.forEach(issue => {
                html += `
                    <tr class="bg-white border-b border-gray-100 hover:bg-gray-50 print-break-inside-avoid">
                        <td class="px-6 py-4 text-center font-bold text-gray-900">#${issue.index}</td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-800">åƒç´ åå·®</div>
                            <div class="text-xs text-gray-400 mt-1">è®¾è®¡ç‚¹: (${Math.round(issue.p1.x)}, ${Math.round(issue.p1.y)})</div>
                        </td>
                        <td class="px-6 py-4 font-mono text-xs">
                            <div>X: <span class="${issue.dx!==0?'text-red-600 font-bold':''}">${issue.dx > 0 ? '+' : ''}${issue.dx}px</span></div>
                            <div>Y: <span class="${issue.dy!==0?'text-red-600 font-bold':''}">${issue.dy > 0 ? '+' : ''}${issue.dy}px</span></div>
                            <div class="mt-1 text-gray-400">è·ç¦»: ${issue.dist}px</div>
                        </td>
                        <td class="px-6 py-4 text-right font-bold text-red-500">-2</td>
                    </tr>`;
            });

            html += `</tbody></table></div></div><div class="mt-10 text-center text-gray-400 text-sm pt-4 border-t border-gray-100">Generated by Design Review Tool</div>`;
            
            els.reportContent.innerHTML = html;
            els.printContainer.classList.remove('hidden');
        }
        function closePrintPreview() { els.printContainer.classList.add('hidden'); }
        function exportIssues() { showPrintPreview(); }

        function moveDev(dx, dy) { state.devOffset.x += dx; state.devOffset.y += dy; updateDevPosition(); }
        function onUIArrowClick(e, x, y) { const step = e.shiftKey ? 10 : 1; moveDev(x * step, y * step); }
        
        function resetDevOffset() { 
            state.devOffset = { x: 0, y: 0 }; 
            updateDevPosition(); 
        }

        // æ–°å¢ï¼šå¤„ç†æ‰‹åŠ¨è¾“å…¥åæ ‡
        function handleManualOffsetInput() {
            const xVal = parseInt(els.inputOffsetX.value);
            const yVal = parseInt(els.inputOffsetY.value);
            
            state.devOffset.x = isNaN(xVal) ? 0 : xVal;
            state.devOffset.y = isNaN(yVal) ? 0 : yVal;
            
            updateDevPosition(false); // ä¼ å…¥ false è¡¨ç¤ºä¸è¦åå‘æ›´æ–°è¾“å…¥æ¡†ï¼Œé¿å…å…‰æ ‡è·³åŠ¨
        }

        function updateDevPosition(updateInputs = true) {
            updateDevLayer();
            
            // å¦‚æœæ˜¯ä»é”®ç›˜/æŒ‰é’®è§¦å‘çš„ç§»åŠ¨ï¼Œéœ€è¦æ›´æ–°è¾“å…¥æ¡†çš„å€¼
            if (updateInputs) {
                els.inputOffsetX.value = state.devOffset.x;
                els.inputOffsetY.value = state.devOffset.y;
            }
            
            if (state.mode === 'diff') computeDiff();
        }
        
        function handleKeydown(e) {
            if (!state.isLoaded || document.activeElement !== document.body && document.activeElement !== els.workspace) return;
            const step = e.shiftKey ? 10 : 1;
            switch(e.key) {
                case 'ArrowUp': moveDev(0, -step); e.preventDefault(); break;
                case 'ArrowDown': moveDev(0, step); e.preventDefault(); break;
                case 'ArrowLeft': moveDev(-step, 0); e.preventDefault(); break;
                case 'ArrowRight': moveDev(step, 0); e.preventDefault(); break;
            }
        }

        function setMode(mode) {
            state.mode = mode;
            state.measure.p1 = null; state.measure.p2 = null;
            clearInteractionCanvas();
            els.infoPanel.classList.add('hidden');

            ['slider', 'measure', 'diff'].forEach(m => {
                const btn = document.getElementById(`btn-${m}`);
                btn.className = `mode-btn px-4 py-2 rounded-md flex items-center gap-2 text-xs font-bold transition ${m === mode ? 'bg-blue-600 text-white shadow-lg shadow-blue-600/20' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`;
            });

            els.diffCanvas.classList.add('opacity-0');
            
            if (mode === 'slider') {
                els.devWrapper.style.width = '100%'; els.devWrapper.style.clipPath = 'inset(0 0 0 50%)'; 
                els.sliderHandle.style.display = 'block'; els.sliderHandle.style.left = '50%';
                els.devLayer.style.opacity = 1; els.opacitySlider.value = 100;
            } else if (mode === 'measure') {
                els.devWrapper.style.width = '100%'; els.devWrapper.style.clipPath = 'none'; 
                els.sliderHandle.style.display = 'none'; els.devLayer.style.opacity = 0.5; els.opacitySlider.value = 50;
            } else if (mode === 'diff') {
                els.devWrapper.style.width = '100%'; els.devWrapper.style.clipPath = 'none';
                els.sliderHandle.style.display = 'none'; els.devLayer.style.opacity = 0; 
                els.diffCanvas.classList.remove('opacity-0'); els.opacitySlider.value = 0;
                computeDiff();
            }
            els.workspace.focus();
        }

        function updateOpacity(val) { if (state.mode !== 'diff') els.devLayer.style.opacity = val / 100; }

        function handleMouseMove(e) {
            const rect = els.workspace.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            els.cursorX.style.top = `${e.clientY}px`;
            els.cursorY.style.left = `${e.clientX}px`;

            const layersRect = els.layersWrapper.getBoundingClientRect();
            const canvasX = e.clientX - layersRect.left;
            const canvasY = e.clientY - layersRect.top;

            if (canvasX < 0 || canvasX > 750 || canvasY < 0) return; 

            // 750px is the ONLY truth now. No scaling needed for logic coords if we assume display is 750px logical
            // But wait, if layersRect.width is NOT 750 (e.g. browser zoom or CSS shrinking), we must normalize.
            // The canvas internal width is 750.
            const scale = 750 / layersRect.width;
            const normalizedX = canvasX * scale;
            const normalizedY = canvasY * scale;

            if (state.mode === 'slider') {
                let percentage = (canvasX / layersRect.width) * 100;
                percentage = Math.max(0, Math.min(100, percentage)); 
                els.devWrapper.style.clipPath = `inset(0 0 0 ${percentage}%)`;
                els.sliderHandle.style.left = `${percentage}%`;
            } else if (state.mode === 'measure') {
                if (state.measure.p1 && !state.measure.p2) {
                    let targetX = normalizedX; let targetY = normalizedY;
                    if (e.shiftKey) {
                        const dx = Math.abs(targetX - state.measure.p1.x);
                        const dy = Math.abs(targetY - state.measure.p1.y);
                        if (dx > dy) targetY = state.measure.p1.y; else targetX = state.measure.p1.x;
                    }
                    drawDynamicLine(state.measure.p1, {x: targetX, y: targetY});
                    
                    const dX = Math.round(targetX - state.measure.p1.x);
                    const dY = Math.round(targetY - state.measure.p1.y);
                    const dist = Math.sqrt(dX*dX + dY*dY).toFixed(1);
                    document.getElementById('live-dist').textContent = `${dist}px`;
                    document.getElementById('live-dx').textContent = dX;
                    document.getElementById('live-dy').textContent = dY;
                    els.infoPanel.classList.remove('hidden');
                }
            }
        }

        function handleCanvasClick(e) {
            const layersRect = els.layersWrapper.getBoundingClientRect();
            const canvasX = e.clientX - layersRect.left;
            const canvasY = e.clientY - layersRect.top;
            if(canvasX < 0 || canvasX > layersRect.width || canvasY < 0) return;
            const scale = 750 / layersRect.width;
            const normalizedX = canvasX * scale;
            const normalizedY = canvasY * scale;
            if (state.mode === 'measure') handleMeasureClick(normalizedX, normalizedY, e.shiftKey);
        }

        function handleMeasureClick(x, y, isShift) {
            if (!state.measure.p1) {
                state.measure.p1 = {x, y};
                drawPoint(x, y, '#3b82f6');
            } else {
                let finalX = x; let finalY = y;
                if (isShift) {
                     const diffX = Math.abs(finalX - state.measure.p1.x);
                     const diffY = Math.abs(finalY - state.measure.p1.y);
                     if (diffX > diffY) finalY = state.measure.p1.y; else finalX = state.measure.p1.x;
                }
                state.measure.p2 = {x: finalX, y: finalY};
                addIssue(state.measure.p1, state.measure.p2);
                state.measure.p1 = null; state.measure.p2 = null;
                clearInteractionCanvas();
                els.infoPanel.classList.add('hidden');
            }
        }

        function clearInteractionCanvas() { ctxInteract.clearRect(0, 0, 750, state.height); }
        
        function drawPoint(x, y, color) {
            ctxInteract.beginPath(); ctxInteract.arc(x, y, 4, 0, Math.PI * 2);
            ctxInteract.fillStyle = color; ctxInteract.fill();
            ctxInteract.strokeStyle = 'white'; ctxInteract.lineWidth = 1; ctxInteract.stroke();
        }
        function drawDynamicLine(p1, p2) {
            clearInteractionCanvas();
            drawPoint(p1.x, p1.y, '#3b82f6');
            ctxInteract.beginPath(); ctxInteract.moveTo(p1.x, p1.y); ctxInteract.lineTo(p2.x, p2.y);
            ctxInteract.strokeStyle = '#94a3b8'; ctxInteract.lineWidth = 1; ctxInteract.setLineDash([5, 5]); ctxInteract.stroke();
        }

        function computeDiff() {
            const c1 = document.createElement('canvas'); c1.width = 750; c1.height = state.height;
            const c2 = document.createElement('canvas'); c2.width = 750; c2.height = state.height;
            c1.getContext('2d').drawImage(els.designLayer, 0, 0);
            c2.getContext('2d').drawImage(els.devLayer, 0, 0);
            const d1 = c1.getContext('2d').getImageData(0,0,750,state.height).data;
            const d2 = c2.getContext('2d').getImageData(0,0,750,state.height).data;
            const out = ctxDiff.createImageData(750, state.height);
            const data = out.data;
            for(let i=0; i<d1.length; i+=4) {
                if(Math.abs(d1[i]-d2[i]) + Math.abs(d1[i+1]-d2[i+1]) + Math.abs(d1[i+2]-d2[i+2]) > 15 && (d1[i+3]>0 || d2[i+3]>0)) {
                    data[i]=239; data[i+1]=68; data[i+2]=68; data[i+3]=180; 
                }
            }
            ctxDiff.putImageData(out, 0, 0);
        }

        // --- AI & Misc ---
        function resetAll() { location.reload(); }
        function toggleAIModal() { els.aiModal.classList.toggle('hidden'); }
        async function runAIAnalysis() {
            if (!state.designImg || !state.devImg) return;
            els.aiContent.innerHTML = ''; els.aiContent.appendChild(els.aiLoading); els.aiLoading.classList.remove('hidden');
            try {
                const snapshots = createGlobalSnapshots();
                const designBase64 = snapshots.design.split(',')[1];
                const devBase64 = snapshots.dev.split(',')[1];
                const prompt = `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„ UI/UX è®¾è®¡éªŒæ”¶ä¸“å®¶...`;
                const result = await callGeminiAPI(prompt, [designBase64, devBase64]);
                els.aiLoading.classList.add('hidden');
                els.aiContent.innerHTML = `<div class="prose prose-invert max-w-none text-sm leading-relaxed">${marked.parse(result)}</div>`;
            } catch (error) {
                els.aiLoading.classList.add('hidden');
                els.aiContent.innerHTML = `<div class="text-center text-red-400 py-8"><p>åˆ†æå¤±è´¥</p><p class="text-xs opacity-70 mt-1">${error.message}</p></div>`;
            }
        }
        function resizeAndConvert(imgElement) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                const maxDim = 800; let w = imgElement.width; let h = imgElement.height;
                if (w > maxDim || h > maxDim) { if (w > h) { h = (h / w) * maxDim; w = maxDim; } else { w = (w / h) * maxDim; h = maxDim; } }
                canvas.width = w; canvas.height = h; ctx.drawImage(imgElement, 0, 0, w, h);
                resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
            });
        }
        async function callGeminiAPI(prompt, imagesBase64) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const parts = [{ text: prompt }];
            imagesBase64.forEach(img => parts.push({ inline_data: { mime_type: "image/jpeg", data: img } }));
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: parts }] }) });
            if (!response.ok) throw new Error('API Request Failed');
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }
    </script>
</body>
</html>